<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css"
          rel="stylesheet"/>
    <style>
        body {
            padding-top: 40px;
        }

        .progress {
            height: 32px;
        }

        a.btn {
            margin-bottom: 2px;
        }
        img{
            cursor: pointer;
        }

    </style>
</head>
<body>
<div class="container">


    <br/>

    <input type="file">

    <br/>
    <br/>

    <div class="row">
        <div class="span8">
            <div class="progress progress-striped progress-success">
                <div class="bar" style="width: 0%;"></div>
            </div>
        </div>
        <div class="span4">
            <button class="btn stop" id="toggle-btn">start upload</button>
        </div>

    </div>
    <div class="upload-text-progress" id="js-upload-text-progress"></div>
    <hr/>
    <h3>Uploads</h3>
    <p id="upload-list">
        Succesful uploads will be listed here. Try one!
    </p>

</div>
<script src="dist/tus.js"></script>
<script>



    let upload          = null
    let uploadIsRunning = false
    const toggleBtn       = document.querySelector('#toggle-btn')
    const input           = document.querySelector('input[type=file]')
    const progress        = document.querySelector('.progress')
    const progressBar     = progress.querySelector('.bar')
    const alertBox        = document.querySelector('#support-alert')
    const uploadList      = document.querySelector('#upload-list')
    const chunkInput      = document.querySelector('#chunksize')
    const endpointInput   = document.querySelector('#endpoint')
    const textProgress    = document.querySelector('#js-upload-text-progress')

    if (!tus.isSupported) {
        alertBox.classList.remove('hidden')
    }

    if (!toggleBtn) {
        throw new Error('Toggle button not found on this page. Aborting upload-demo. ')
    }

    toggleBtn.addEventListener('click', (e) => {
        e.preventDefault()

        if (upload) {
            if (uploadIsRunning) {
                upload.abort()
                toggleBtn.textContent = 'resume upload'
                uploadIsRunning = false
            } else {
                upload.start()
                toggleBtn.textContent = 'pause upload'
                uploadIsRunning = true
            }
        } else if (input.files.length > 0) {
            startUpload()
        } else {
            input.click()
        }
    })


    input.addEventListener('change', startUpload)

    function startUpload () {
        const file = input.files[0]

        if (!file) {
            return
        }

        toggleBtn.textContent = 'pause upload'

        const options = {
            endpoint   : 'https://tusd.tusdemo.net/files/',
            retryDelays: [0, 1000, 3000],
            chunkSize: '2097152',
            metadata   : {
                filename: file.name,
                filetype: file.type,
            },
            onError (error) {
                if (error.originalRequest) {
                    if (window.confirm(`Failed because: ${error}\nDo you want to retry?`)) {
                        upload.start()
                        uploadIsRunning = true
                        return
                    }
                } else {
                    window.alert(`Failed because: ${error}`)
                }

                reset()
            },
            onProgress (bytesUploaded, bytesTotal) {
                const percentage = (bytesUploaded / bytesTotal * 100).toFixed(2)
                progressBar.style.width = `${percentage}%`
                console.log(bytesUploaded, bytesTotal, `${percentage}%`)
                textProgress.textContent = `Uploaded ${formatBytes(bytesUploaded)} of ${formatBytes(bytesTotal)} (${percentage}%)`
            },
            onSuccess () {
                const anchor = document.createElement('a')
                anchor.textContent = `Download ${upload.file.name} (${upload.file.size} bytes)`
                anchor.href = upload.url
                anchor.className = 'btn btn-success'
                uploadList.appendChild(anchor)

                reset()
            },
        }

        upload = new tus.Upload(file, options)
        upload.findPreviousUploads().then((previousUploads) => {
            askToResumeUpload(previousUploads, upload)

            upload.start()
            uploadIsRunning = true
        })
    }

    function reset() {
        input.value = "";
        toggleBtn.textContent = "start upload";
        upload = null;
        uploadIsRunning = false;
    }

    function askToResumeUpload (previousUploads, upload) {
        if (previousUploads.length === 0) return

        let text = 'You tried to upload this file previously at these times:\n\n'
        previousUploads.forEach((previousUpload, index) => {
            text += `[${index}] ${previousUpload.creationTime}\n`
        })
        text += '\nEnter the corresponding number to resume an upload or press Cancel to start a new upload'

        const answer = prompt(text)
        const index = parseInt(answer, 10)

        if (!isNaN(index) && previousUploads[index]) {
            upload.resumeFromPreviousUpload(previousUploads[index])
        }
    }
    function formatBytes (bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes'

        const k = 1024
        const dm = decimals < 0 ? 0 : decimals
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']

        const i = Math.floor(Math.log(bytes) / Math.log(k))

        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]
    }


</script>
</body>
</html>
